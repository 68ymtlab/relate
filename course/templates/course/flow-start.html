{% extends "course/course-base.html" %}

{% block title %}
  {{flow_desc.title}} - CourseFlow
{% endblock %}

{% block content %}
  {% if flow_desc.description %}
  {{flow_desc.description_html|safe}}
  {% endif %}

  <form method="POST">
    {% csrf_token %}

    {# {{{ describe rules #}
    {% if rules or grade_aggregation_strategy %}
    <div class="well">
      <h3 class="start-well-title">Rules</h3>
      {% if grade_aggregation_strategy %}
        <p>
          If multiple grades are available, the policy will be to
          '{{ grade_aggregation_strategy }}'.
        </p>
      {% endif %}
      {% for rule in rules %}
        {% if rule.is_current %}
          <div class="current-access-rule">
        {% else %}
          <div>
        {% endif %}

        {% if rule.start != None %}
          {% if rule.end != None %}
            The following rules apply between
            <i>{{ rule.start }}</i>
            and
            <i>{{ rule.end }}</i>:
          {% else %}
            The following rules apply from <i>{{ rule.start }}</i>:
          {% endif %}
        {% else %}
          {% if rule.end != None %}
          The following rules apply until <i>{{ rule.end }}</i>:
          {% else %}
            Unless specified otherwise above, the following rules apply:
          {% endif %}
        {% endif %}

        {% if rule.is_exception %}
        (This rule is an exception that only applies to you.)
        {% endif %}

        {% if rule.id %}
        (<tt>{{ rule.id }}</tt>)
        {% endif %}

        {% if rule.is_current %}
        <b>(currently in effect)</b>
        {% endif %}

        <ul>
          {% if rule.permissions %}
            <li>You may: <i>{{ rule.human_readable_permissions |join:", " }}</i>.
          {% else %}
            <li>
              You are not allowed to interact with this flow.
              {% if not user.is_authenticated %}
                <a href="{% url student_sign_in_view %}">Sign in</a> to get started.
              {% elif participation == None %}
                Enroll in this course to get started.
              {% endif %}
            </li>
          {% endif %}

          {% if rule.credit_percent != None %}
            <li>
            You receive {{ rule.credit_percent }}% credit for
            completing this flow for-credit.
            </li>
          {% endif %}
          {% if rule.allowed_session_count %}
            <li>
            {{ rule.allowed_session_count }}
            attempt{{ rule.allowed_session_count|pluralize }} permitted.
            </li>
          {% endif %}
        </ul>
      </div>
      {% endfor %}
    </div>
    {% endif %}
    {# }}} #}

    {% if may_start_credit or may_start_no_credit or past_sessions %}
      <div class="well">
        {% if past_sessions %}
          <h3 class="start-well-title">Past sessions</h3>

          <table class="past-flow-session-table">
            <tr>
              <th>Start time</th>
              <th>State</th>
              <th>Rules</th>
              <th>Result</th>
              <th>Actions</th>
            </tr>
            {% for flow_session in past_sessions %}
              <tr>
                <td>{{ flow_session.start_time }}</td>
                <td>
                  {% if flow_session.for_credit %}
                    <span class="label label-danger">for credit</span>
                  {% else %}
                    <span class="label label-success">not for credit</span>
                  {% endif %}
                  {% if flow_session.in_progress %}
                    <span class="label label-warning">in progress</span>
                  {% else %}
                    <span class="label label-success">finished</span>
                    ({{ flow_session.completion_time }})
                  {% endif %}
                </td>
                <td>
                  {% if flow_session.access_rules_id %}
                    <tt>{{ flow_session.access_rules_id  }}</tt>
                  {% else %}
                    (None)
                  {% endif %}
                </td>
                <td>
                  {% if flow_session.max_points %}
                    <b>{{ flow_session.points|floatformat }}</b>
                    out of
                    {{ flow_session.max_points|floatformat }}

                    (<b>{{ flow_session.points_percentage|floatformat }}%</b>)
                  {% else %}
                    (none)
                  {% endif %}

                </td>
                <td>
                  {% if flow_session.in_progress %}
                    <button type="submit" name="resume_{{flow_session.id}}" class="btn btn-primary btn-xs">
                      Resume &raquo;
                    </button>
                  {% elif may_review %}
                    <button type="submit" name="resume_{{flow_session.id}}" class="btn btn-primary btn-xs">
                      Review &raquo;
                    </button>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </table>
        {% endif %}

        {% if may_start_no_credit %}
          <button type="submit" name="start_no_credit" class="btn btn-primary">
            {% if may_start_credit %}
              Start without credit &raquo;
            {% else %}
              Start &raquo;
            {% endif %}
          </button>
        {% endif %}
        {% if may_start_credit %}
          <button type="submit" name="start_credit" class="btn btn-primary">Start new for-credit attempt &raquo;</button>
        {% endif %}
      </div>
    {% endif %}
  </form>

{% endblock %}

{# vim: set foldmethod=marker: #}
